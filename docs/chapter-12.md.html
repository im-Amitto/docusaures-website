<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Introduction to Authorization · BigBinary</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h2&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;what-is-authorization&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#what-is-authorization&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;What is Authorization ?&lt;/h2&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Introduction to Authorization · BigBinary"/><meta property="og:type" content="website"/><meta property="og:url" content="https://im-amitto.github.io/https://im-amitto.github.io/docusaures-website/"/><meta property="og:description" content="&lt;h2&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;what-is-authorization&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#what-is-authorization&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;What is Authorization ?&lt;/h2&gt;
"/><meta property="og:image" content="https://im-amitto.github.io/https://im-amitto.github.io/docusaures-website/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://im-amitto.github.io/https://im-amitto.github.io/docusaures-website/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="https://im-amitto.github.io/docusaures-website/img/logo.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="./../css/prism.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="./../js/code-block-buttons.js"></script><script type="text/javascript" src="./../js/prism.js"></script><script type="text/javascript" src="./../js/highlighter.js"></script><link rel="stylesheet" href="https://im-amitto.github.io/docusaures-website/css/main.css"/><script src="https://im-amitto.github.io/docusaures-website/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="https://im-amitto.github.io/docusaures-website/"><img class="logo" src="https://im-amitto.github.io/docusaures-website/img/logo.png" alt="BigBinary"/><h2 class="headerTitleWithLogo">BigBinary</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"></ul></nav></div></header></div></div><div class="navPusher singleRowMobileNav"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>book</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">book</h3><ul class=""><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/">Introduction</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-0.md">Installing Ruby on Rails and VSCode</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-1.md">Building a new Rails application</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-2.md">Getting started with Ruby on Rails</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-3.md">Task controller</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-4.md">Adding tasks through browser</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-5.md">Show a task</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-6.md">Update the task</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-7.md">Delete the task</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-8.md">Introduction to Validation</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-9.md">Active Record Callbacks and Object Life Cycle</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-10.md">Introducing User model</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-11.md">Authentication</a></li><li class="navListItem navListItemActive"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-12.md">Introduction to Authorization</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-13.md">State Management via Ajax</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-14.md">Adding comments to Tasks</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-15.md">Attaching files</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-16.md">Introduction to Testing and Writing Unit Tests</a></li><li class="navListItem"><a class="navItem" href="https://im-amitto.github.io/docusaures-website/docs/chapter-19.md">Configuring Queue Adapters for Background Processing</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Introduction to Authorization</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="what-is-authorization"></a><a href="#what-is-authorization" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is Authorization ?</h2>
<p>Authorization in simple terms, means <code>What all You can do</code>. The <code>You</code> comes from the authentication which we saw in the previous chapter and as we can’t determine <code>what you can do</code> unless we know <code>who you are</code>, this makes <code>Authentication</code> to be required for <code>Authorization</code>.</p>
<p>So in this chapter, we'll <code>authorize</code> the <code>user</code> to <code>view</code> the <code>tasks</code> only if the task is <code>created</code> by the logged in user or <code>assigned</code> to it.</p>
<h2><a class="anchor" aria-hidden="true" id="introduction-to-pundit-gem"></a><a href="#introduction-to-pundit-gem" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction to Pundit gem</h2>
<p>Let's consider for once, adding Authorization to our existing application without any extra help. Which files would we start making the changes to? It would be our existing <code>task</code> and <code>user</code> models and controllers etc.</p>
<p>Hence to take away the code complexity from these files, we'll introduce <code>Pundit</code> gem. Now the advantage is that we get to keep our controllers and models skinny.</p>
<p>Pundit helps us in creating role based authorization. It helps us to define policies which are <code>PORC - Plain Old Ruby Classes</code> which means that the class does not inherit from other classes nor include in other modules from the framework. Thus makes it very easy to understand the code.</p>
<h2><a class="anchor" aria-hidden="true" id="pundit-gem-installation"></a><a href="#pundit-gem-installation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pundit gem installation.</h2>
<ul>
<li><p>Add <strong>gem 'pundit'</strong> to your Gemfile.</p></li>
<li><p>Include Pundit in your application controller:</p></li>
</ul>
<pre><code class="hljs css language-ruby">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationController</span> &lt; ActionController::Base</span>
    <span class="hljs-keyword">include</span> Pundit
  <span class="hljs-keyword">end</span>
</code></pre>
<ul>
<li>Run command <strong>bundle install</strong>.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="introduction-to-policies"></a><a href="#introduction-to-policies" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction to Policies</h2>
<p><code>Policies</code>, as defined before, are <code>PORC</code>, which house the authorization for a particular page. Here we'll craete a new folder under our <code>app</code> directory and name it <code>policies</code> and that would add a file named <code>task_policy.rb</code>. Then we'll add the following code.</p>
<pre><code class="hljs css language-ruby">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskPolicy</span></span>
    <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:user</span>, <span class="hljs-symbol">:task</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(user, task)</span></span>
      @user = user
      @task = task
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># CRUD actions</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show?</span></span>
      <span class="hljs-comment"># some condition which returns a boolean value</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
</code></pre>
<p>Pundit makes the following assumptions about this class:</p>
<ul>
<li>The class has the same name as that of model class, only suffixed with the word &quot;Policy&quot;.Hence, the name TaskPolicy.</li>
<li>The first argument is a <code>user</code>. In your controller, Pundit will call the <code>current_user</code> method to retrieve what to send       into this argument.</li>
<li>The second argument is that of a model object, whose authorization you want to check.</li>
<li>The class implements some kind of query method, in this case show?. Usually, this will map to the name of a particular       controller action.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="add-taskpolicy"></a><a href="#add-taskpolicy" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Add TaskPolicy</h2>
<p>Now let's look add the required code for class <code>TaskPolicy</code></p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskPolicy</span></span>
  <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:user</span>, <span class="hljs-symbol">:task</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(user, task)</span></span>
    @user = user
    @task = task
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># show? action is invoked when we call `authorize <span class="hljs-doctag">@task</span>` in show action of the controller.</span>
  <span class="hljs-comment"># Here the condition that we want to check is whether the record's creator is current user or record is assigned to current   # user.</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show?</span></span>
    task.creator_id == user.id <span class="hljs-params">||</span> task.assignee_id == user.id
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># The condition to make sure a task is editable is the same as that of the show action.</span>
  <span class="hljs-comment"># So all we'll do is simply call `show?` inside the edit? action</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit?</span></span>
    show?
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># Similar is the case for update? action</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update?</span></span>
    show?
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># Every user can create a task, hence create? will always return true</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create?</span></span>
    <span class="hljs-literal">true</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># Only the user that has created the task, can delete it</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">destroy?</span></span>
    task.creator_id == user.id
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment">#----previous code below -----</span>
</code></pre>
<p>Now, let's add the authorize method to our controller actions. The required code is added as follows:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TasksController</span> &lt; ApplicationController</span>
  before_action <span class="hljs-symbol">:require_login</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span></span>
    @tasks = policy_scope(Task)
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new</span></span>
    @task = Task.new
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
    @user = User.find(user_params[<span class="hljs-symbol">:user_id</span>])
    @task = @user.tasks.new(task_params)
    authorize @task
    @task.creator_id = current_user.id

    <span class="hljs-keyword">if</span> @task.valid?
      @task.save
      redirect_to task_url(@task)
    <span class="hljs-keyword">else</span>
      render new
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show</span></span>
    @task = Task.find(params[<span class="hljs-symbol">:id</span>])
    authorize @task
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">edit</span></span>
    @task = Task.find(params[<span class="hljs-symbol">:id</span>])
    authorize @task
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>
    @task = Task.find(params[<span class="hljs-symbol">:id</span>])
    authorize @task

    <span class="hljs-keyword">if</span> @task.update_attributes(task_params)
    redirect_to @task
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">destroy</span></span>
    @task = Task.find(params[<span class="hljs-symbol">:id</span>])
    authorize @task
    @task.destroy
    redirect_to tasks_url
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment">#-----previous code below------</span>
</code></pre>
<p>We have added the line <code>authorize @task</code> to <code>show, edit, update and destroy</code> actions after initializing our <code>@task</code> instance variable.</p>
<p>The authorize method automatically infers that <code>Task</code> will have a matching <code>TaskPolicy</code> class, and instantiates this class, handing in the current user and the given record (@task in this case). It then infers from the action name, that it should call the respective action of class <code>TaskPolicy</code>. For example, the instance created by the authorize @task inside the show action, will call the <code>show?</code> action of Policy class.</p>
<p>In the example above of show action, you can imagine that authorize would have done something like this:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-keyword">unless</span> TaskPolicy.new(current_user, @task).show?
  raise Pundit::NotAuthorizedError, <span class="hljs-string">"not allowed to show? this <span class="hljs-subst">#{@task.inspect}</span>"</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>This raises an exception. But Pundit allows us to rescue the exception with a method of our choice. So, let's add the code for that in our <code>application_controller.rb</code>.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationController</span> &lt; ActionController::Base</span>
  <span class="hljs-keyword">include</span> Pundit

  <span class="hljs-comment">#------new line added here-----</span>
  rescue_from Pundit::NotAuthorizedError, <span class="hljs-symbol">with:</span> <span class="hljs-symbol">:user_not_authorized</span>
  <span class="hljs-comment">#------end of added line------</span>

  private

  <span class="hljs-comment">#------previous code-----</span>

  <span class="hljs-comment">#-----new lines added here-----</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">user_not_authorized</span></span>
    flash[<span class="hljs-symbol">:warning</span>] = <span class="hljs-string">"All accesssable tasks are listed below."</span>
    redirect_to root_path
  <span class="hljs-keyword">end</span>
  <span class="hljs-comment">#------end of added lines------</span>

<span class="hljs-keyword">end</span>
</code></pre>
<p>So whenever an action in TaskPolicy returns false (case of authorization fail), an exception is raised which is rescued with the method <code>user_not_authorized</code>.</p>
<p>Let's observe a Use case for above :-</p>
<p>Assumptions-</p>
<ul>
<li>Let's say there exists a task with id = 3 and a user with name = &quot;John&quot;.</li>
<li>Task with id = 3 is neither created by John nor assigned to John.</li>
<li>John logs in by entering his email and password.</li>
<li>Now John, enters the url localhost:3000/tasks/3/show</li>
</ul>
<p>Since John is not authorized to view the task because of the above assumptions, rather than throwing him an error (the red page), Pundit raises an exception and rescues it by calling the method <code>user_not_authorized</code>. A message <code>All accessable tasks are listd below</code>is shown and the user is directed to the root path which was set to index action of tasks' controller's index action previously in this chapter.</p>
<h2><a class="anchor" aria-hidden="true" id="introduction-to-policy-scope"></a><a href="#introduction-to-policy-scope" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction to Policy scope.</h2>
<p>If you closely observe, we did not make a change to our index action. As index action returns a collection of records, we need to apply a condition on a collection and we do that by using <code>Policy Scope</code>.</p>
<p>As we want to have our index view to display only the tasks which are either created by the current_user or assigned to the current_user, we will define a class called a policy scope. This class is nested inside the class <code>TaskPolicy</code></p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskPolicy</span></span>

 <span class="hljs-comment">#------previous code -------</span>

 <span class="hljs-comment">#------add new lines here----</span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Scope</span></span>
    <span class="hljs-keyword">attr_reader</span> <span class="hljs-symbol">:user</span>, <span class="hljs-symbol">:scope</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(user, scope)</span></span>
      @user = user
      @scope = scope
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve</span></span>
      scope.where(<span class="hljs-symbol">creator_id:</span> user.id).<span class="hljs-keyword">or</span>(scope.where(<span class="hljs-symbol">assignee_id:</span> user.id))
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Pundit makes the following assumptions about this class:</p>
<ul>
<li>The class has the name Scope and is nested under the policy class.</li>
<li>The first argument is a user. In your controller, Pundit will call the current_user method to retrieve what to send into     this argument.</li>
<li>The second argument is a scope which is a collection of records.</li>
<li>Instances of this class respond to the method resolve.</li>
<li>This method contains the query run on the scope defined and then returns a result which is a collection and can be iterated   over.</li>
</ul>
<p>The corresponding change we make in the index action of Tasks controller is as follows:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span></span>
  <span class="hljs-comment">#------new line added here------</span>
  @tasks = TaskPolicy::Scope.new(current_user, Task).resolve
  <span class="hljs-comment">#-----end of added line-------</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Let's observe what's going on here-</p>
<ul>
<li><p>Pundit creates an instance of class Scope (nested inside the class TaskPolicy) passing along the <code>current_user</code> and the <code>Task</code> model (our <code>scope</code> in this case) as parameters which get set in the <code>@user</code> and <code>@scope</code> instance variables   respectively inside the initialize method.</p></li>
<li><p>Now this instance calls the method <code>resolve</code> where we run a query on our scope and it returns a collection of tasks which only       have the tasks that are either created by or assigned to the current_user.</p></li>
</ul>
<p>Now to make it easier Pundit provides syntactic sugar where we can replace the line <code>TaskPolicy::Scope.new(current_user, Task).resolve</code> simply with the syntax <code>policy_scope(Task)</code>. It works exactly the same way as described before.</p>
<p>So now our code looks like:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span></span>
  <span class="hljs-comment">#------new line added here------</span>
  @tasks = policy_scope(Task)
  <span class="hljs-comment">#-----end of added line-------</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>This way we have authorized our user for all the controller actions and hence you can try running this in your applicaiton.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="https://im-amitto.github.io/docusaures-website/docs/chapter-11.md"><span class="arrow-prev">← </span><span>Authentication</span></a><a class="docs-next button" href="https://im-amitto.github.io/docusaures-website/docs/chapter-13.md"><span>State Management via Ajax</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#what-is-authorization">What is Authorization ?</a></li><li><a href="#introduction-to-pundit-gem">Introduction to Pundit gem</a></li><li><a href="#pundit-gem-installation">Pundit gem installation.</a></li><li><a href="#introduction-to-policies">Introduction to Policies</a></li><li><a href="#add-taskpolicy">Add TaskPolicy</a></li><li><a href="#introduction-to-policy-scope">Introduction to Policy scope.</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2019 BigBinary</section></footer></div></body></html>